<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post-Processing - Voice Dataset Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', path='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-microphone me-2"></i>Voice Dataset Manager
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/record">Record</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/profiles">Profiles</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/postprocess">Post-Process</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/export">Export</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">Audio Post-Processing</h1>
                <p class="lead">Process your recorded audio files with silence trimming and volume normalization</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>Processing Settings
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="postProcessForm">
                            <div class="mb-3">
                                <label for="voiceProfile" class="form-label">Voice Profile</label>
                                <select class="form-select" id="voiceProfile" required>
                                    <option value="">Select a voice profile...</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="promptList" class="form-label">Prompt Lists <span class="badge bg-info">Multiple Selection Supported</span></label>
                                <select class="form-select" id="promptList" multiple size="5" required>
                                    <option value="">Select prompt lists...</option>
                                </select>
                                <small class="form-text text-muted">Hold Ctrl (Windows/Linux) or Cmd (Mac) to select multiple lists</small>
                            </div>

                            <div class="mb-3">
                                <label for="silenceThreshold" class="form-label">Silence Threshold (dB)</label>
                                <input type="range" class="form-range" id="silenceThreshold" min="-60" max="-20" value="-40" step="5">
                                <div class="d-flex justify-content-between">
                                    <small>-60 dB</small>
                                    <small id="silenceThresholdValue">-40 dB</small>
                                    <small>-20 dB</small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="targetVolume" class="form-label">Target Volume (dB) <span class="badge bg-success">Recommended: -6 dB</span></label>
                                <input type="range" class="form-range" id="targetVolume" min="-20" max="-1" value="-6" step="1">
                                <div class="d-flex justify-content-between">
                                    <small>-20 dB</small>
                                    <small id="targetVolumeValue">-6 dB</small>
                                    <small>-1 dB</small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="targetSampleRate" class="form-label">Target Sample Rate (Hz)</label>
                                <select class="form-select" id="targetSampleRate">
                                    <option value="22050">22,050 Hz (Standard TTS)</option>
                                    <option value="44100" selected>44,100 Hz (CD Quality - Recommended)</option>
                                    <option value="48000">48,000 Hz (Studio Quality)</option>
                                    <option value="16000">16,000 Hz (Telephony)</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="silencePadding" class="form-label">Silence Padding (ms)</label>
                                <input type="range" class="form-range" id="silencePadding" min="0" max="1000" value="200" step="50">
                                <div class="d-flex justify-content-between">
                                    <small>0 ms</small>
                                    <small id="silencePaddingValue">200 ms</small>
                                    <small>1000 ms</small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="createBackup" checked>
                                    <label class="form-check-label" for="createBackup">
                                        Create backup of original files
                                    </label>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-warning w-100" id="processButton">
                                <i class="fas fa-play me-2"></i>Start Processing
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>Processing Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="processingInfo">
                            <div class="text-center text-muted">
                                <i class="fas fa-info-circle me-2"></i>Select a voice profile and prompt list to see processing information
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>Processing Progress
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="progressContainer" class="d-none">
                            <div class="progress mb-3">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span id="progressText">0 / 0 files processed</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div id="currentFile" class="mt-2 small text-muted"></div>
                        </div>
                        <div id="noProgress" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>No processing in progress
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>Processing History
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="processingHistory">
                            <div class="text-center text-muted">
                                <i class="fas fa-info-circle me-2"></i>No processing history available
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', path='js/app.js') }}"></script>
    <script>
        let currentProcessingJob = null;
        let progressInterval = null;

        // Load voice profiles on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadVoiceProfiles();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Range slider updates
            document.getElementById('silenceThreshold').addEventListener('input', function() {
                document.getElementById('silenceThresholdValue').textContent = this.value + ' dB';
            });

            document.getElementById('targetVolume').addEventListener('input', function() {
                document.getElementById('targetVolumeValue').textContent = this.value + ' dB';
            });

            document.getElementById('silencePadding').addEventListener('input', function() {
                document.getElementById('silencePaddingValue').textContent = this.value + ' ms';
            });

            // Form submission
            document.getElementById('postProcessForm').addEventListener('submit', function(e) {
                e.preventDefault();
                startProcessing();
            });

            // Voice profile change
            document.getElementById('voiceProfile').addEventListener('change', function() {
                loadPromptLists();
                updateProcessingInfo();
            });

            // Prompt list change
            document.getElementById('promptList').addEventListener('change', function() {
                updateProcessingInfo();
            });
        }

        function loadVoiceProfiles() {
            fetch('/api/profiles')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('voiceProfile');
                    select.innerHTML = '<option value="">Select a voice profile...</option>';
                    data.forEach(profile => {
                        const option = document.createElement('option');
                        option.value = profile.id;
                        option.textContent = profile.name;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading profiles:', error));
        }

        function loadPromptLists() {
            const profileId = document.getElementById('voiceProfile').value;
            if (!profileId) {
                document.getElementById('promptList').innerHTML = '<option value="">Select a prompt list...</option>';
                return;
            }

            fetch(`/api/postprocess/datasets/${profileId}`)
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('promptList');
                    select.innerHTML = '<option value="">Select a prompt list...</option>';
                    data.forEach(dataset => {
                        const option = document.createElement('option');
                        option.value = dataset.id;
                        option.textContent = dataset.display_name;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading prompt lists:', error));
        }

        function updateProcessingInfo() {
            const profileId = document.getElementById('voiceProfile').value;
            const promptListSelect = document.getElementById('promptList');
            const selectedOptions = Array.from(promptListSelect.selectedOptions).map(opt => opt.value).filter(v => v);

            if (!profileId || selectedOptions.length === 0) {
                document.getElementById('processingInfo').innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-info-circle me-2"></i>Select a voice profile and at least one prompt list
                    </div>
                `;
                return;
            }

            // Get processing information for all selected prompt lists
            Promise.all(selectedOptions.map(promptListId =>
                fetch(`/api/postprocess/info/${profileId}/${promptListId}`).then(r => r.json())
            ))
                .then(results => {
                    // Aggregate data from all prompt lists
                    const totalFiles = results.reduce((sum, r) => sum + r.total_files, 0);
                    const totalDuration = results.reduce((sum, r) => sum + r.total_duration, 0);
                    const totalSize = results.reduce((sum, r) => sum + r.total_size, 0);
                    const avgDuration = totalFiles > 0 ? totalDuration / totalFiles : 0;

                    document.getElementById('processingInfo').innerHTML = `
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-layer-group me-2"></i>Processing ${selectedOptions.length} prompt list(s)
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <strong>Total Files:</strong> ${totalFiles}
                            </div>
                            <div class="col-6">
                                <strong>Total Duration:</strong> ${formatDuration(totalDuration)}
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6">
                                <strong>Average Duration:</strong> ${formatDuration(avgDuration)}
                            </div>
                            <div class="col-6">
                                <strong>File Size:</strong> ${formatFileSize(totalSize)}
                            </div>
                        </div>
                        <div class="mt-3">
                            <strong>Processing Settings:</strong>
                            <ul class="list-unstyled mt-2">
                                <li><i class="fas fa-volume-down me-2"></i>Silence Threshold: <span id="currentSilenceThreshold">-40 dB</span></li>
                                <li><i class="fas fa-volume-up me-2"></i>Target Volume: <span id="currentTargetVolume">-6 dB</span></li>
                                <li><i class="fas fa-broadcast-tower me-2"></i>Sample Rate: <span id="currentSampleRate">44,100 Hz</span></li>
                                <li><i class="fas fa-clock me-2"></i>Silence Padding: <span id="currentSilencePadding">200 ms</span></li>
                            </ul>
                        </div>
                    `;

                    // Update current settings display
                    document.getElementById('currentSilenceThreshold').textContent = document.getElementById('silenceThreshold').value + ' dB';
                    document.getElementById('currentTargetVolume').textContent = document.getElementById('targetVolume').value + ' dB';
                    const sampleRate = document.getElementById('targetSampleRate');
                    document.getElementById('currentSampleRate').textContent = parseInt(sampleRate.value).toLocaleString() + ' Hz';
                    document.getElementById('currentSilencePadding').textContent = document.getElementById('silencePadding').value + ' ms';
                })
                .catch(error => {
                    console.error('Error loading processing info:', error);
                    document.getElementById('processingInfo').innerHTML = `
                        <div class="text-center text-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>Error loading processing information
                        </div>
                    `;
                });
        }

        function startProcessing() {
            const profileId = document.getElementById('voiceProfile').value;
            const promptListSelect = document.getElementById('promptList');
            const promptListIds = Array.from(promptListSelect.selectedOptions).map(opt => opt.value).filter(v => v);
            const silenceThreshold = document.getElementById('silenceThreshold').value;
            const targetVolume = document.getElementById('targetVolume').value;
            const targetSampleRate = document.getElementById('targetSampleRate').value;
            const silencePadding = document.getElementById('silencePadding').value;
            const createBackup = document.getElementById('createBackup').checked;

            if (!profileId || promptListIds.length === 0) {
                alert('Please select a voice profile and at least one prompt list.');
                return;
            }

            const processButton = document.getElementById('processButton');
            processButton.disabled = true;
            processButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting...';

            // Show progress container
            document.getElementById('progressContainer').classList.remove('d-none');
            document.getElementById('noProgress').classList.add('d-none');

            // Start processing
            fetch('/api/postprocess/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    profile_id: profileId,
                    prompt_list_ids: promptListIds,
                    silence_threshold: parseInt(silenceThreshold),
                    target_volume: parseInt(targetVolume),
                    target_sample_rate: parseInt(targetSampleRate),
                    silence_padding: parseInt(silencePadding),
                    create_backup: createBackup
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentProcessingJob = data.job_id;
                    startProgressTracking();
                } else {
                    throw new Error(data.error || 'Failed to start processing');
                }
            })
            .catch(error => {
                console.error('Error starting processing:', error);
                alert('Error starting processing: ' + error.message);
                resetProcessingButton();
            });
        }

        function startProgressTracking() {
            progressInterval = setInterval(() => {
                fetch(`/api/postprocess/status/${currentProcessingJob}`)
                    .then(response => response.json())
                    .then(data => {
                        updateProgress(data);

                        if (data.status === 'completed' || data.status === 'failed') {
                            clearInterval(progressInterval);
                            resetProcessingButton();

                            if (data.status === 'completed') {
                                alert('Processing completed successfully!');
                                loadProcessingHistory();
                            } else {
                                alert('Processing failed: ' + (data.error || 'Unknown error'));
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error checking progress:', error);
                    });
            }, 1000);
        }

        function updateProgress(data) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressPercent = document.getElementById('progressPercent');
            const currentFile = document.getElementById('currentFile');

            const percentage = Math.round((data.processed / data.total) * 100);

            progressBar.style.width = percentage + '%';
            progressText.textContent = `${data.processed} / ${data.total} files processed`;
            progressPercent.textContent = percentage + '%';

            if (data.current_file) {
                currentFile.textContent = `Processing: ${data.current_file}`;
            }
        }

        function resetProcessingButton() {
            const processButton = document.getElementById('processButton');
            processButton.disabled = false;
            processButton.innerHTML = '<i class="fas fa-play me-2"></i>Start Processing';

            document.getElementById('progressContainer').classList.add('d-none');
            document.getElementById('noProgress').classList.remove('d-none');
        }

        function loadProcessingHistory() {
            fetch('/api/postprocess/history')
                .then(response => response.json())
                .then(data => {
                    const historyContainer = document.getElementById('processingHistory');

                    if (!data || data.length === 0) {
                        historyContainer.innerHTML = `
                            <div class="text-center text-muted">
                                <i class="fas fa-info-circle me-2"></i>No processing history available
                            </div>
                        `;
                        return;
                    }

                    historyContainer.innerHTML = data.map(job => `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${job.profile_name} - ${job.prompt_list_name}</h6>
                                <small class="text-muted">${new Date(job.created_at).toLocaleString()}</small>
                            </div>
                            <p class="mb-1">
                                <span class="badge bg-${job.status === 'completed' ? 'success' : job.status === 'failed' ? 'danger' : 'warning'}">${job.status}</span>
                                ${job.processed_files} / ${job.total_files} files processed
                            </p>
                            <small class="text-muted">
                                Settings: ${job.silence_threshold}dB threshold, ${job.target_volume}dB target, ${job.silence_padding}ms padding
                            </small>
                        </div>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error loading processing history:', error);
                });
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);

            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Load processing history on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProcessingHistory();
        });
    </script>
</body>
</html>
