<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train Model - Voice Dataset Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', path='css/style.css') }}" rel="stylesheet">
    <style>
        .parameter-card {
            transition: all 0.3s ease;
        }
        .parameter-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .terminal-output {
            background-color: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
        }
        .parameter-help {
            font-size: 0.85em;
            color: #6c757d;
        }
        .recommended-value {
            background-color: #d4edda;
            color: #155724;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-microphone me-2"></i>Voice Dataset Manager
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/record">Record</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/profiles">Profiles</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/postprocess">Post-Process</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/export">Export</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/train">Train</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">Train Voice Model</h1>
                <p class="lead">Configure training parameters and start training your voice model</p>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <form id="trainingForm">
                    <!-- Training Type Selection -->
                    <div class="card parameter-card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-cogs me-2"></i>Training Type
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="trainingType" id="fromScratch" value="from_scratch" checked>
                                        <label class="form-check-label" for="fromScratch">
                                            <strong>Train from Scratch</strong>
                                        </label>
                                        <div class="parameter-help mt-1">
                                            Start training a completely new model. Takes longer but gives you full control.
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="trainingType" id="fineTune" value="fine_tune">
                                        <label class="form-check-label" for="fineTune">
                                            <strong>Fine-tune from Checkpoint</strong>
                                        </label>
                                        <div class="parameter-help mt-1">
                                            Continue training from an existing model. Faster and often better results.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Checkpoint Selection (only for fine-tuning) -->
                            <div id="checkpointSelection" class="mt-3" style="display: none;">
                                <div class="alert alert-info">
                                    <strong><i class="fas fa-info-circle me-1"></i>Checkpoint Options:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>Pre-trained Base Voice:</strong> Select from available models. Some require manual download.</li>
                                        <li><strong>Custom Checkpoint Path:</strong> Use for manually downloaded checkpoints or local files. Leave dropdown empty when using custom path.</li>
                                    </ul>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="baseVoice" class="form-label">Pre-trained Base Voice</label>
                                        <select class="form-select" id="baseVoice" name="baseVoice">
                                            <option value="">Select a base voice...</option>
                                        </select>
                                        <div class="parameter-help mt-1">
                                            Select from catalog (some may require manual download)
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="checkpointPath" class="form-label">
                                            Custom Checkpoint Path 
                                            <span class="badge bg-warning text-dark">For Manual Downloads</span>
                                        </label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="checkpointPath" placeholder="checkpoints/sv-SE/nst/model.ckpt">
                                            <input type="file" id="checkpointFilePicker" accept=".ckpt,.pt,.pth" style="display: none;" onchange="handleCheckpointFileSelect(this)">
                                            <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('checkpointFilePicker').click()">
                                                <i class="fas fa-folder-open"></i> Browse
                                            </button>
                                        </div>
                                        <div class="parameter-help mt-1">
                                            Path to your manually downloaded checkpoint file. Click Browse to select, or type path manually. Leave "Pre-trained Base Voice" empty when using this.
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="refreshCheckpoints">
                                        <i class="fas fa-sync-alt me-1"></i>Refresh Available Models
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-info" id="downloadCheckpoint" style="display: none;">
                                        <i class="fas fa-download me-1"></i>Download Selected Model
                                    </button>
                                    <span id="checkpointStatus" class="ms-2"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dataset Selection -->
                    <div class="card parameter-card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-database me-2"></i>Dataset Configuration
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="voiceProfile" class="form-label">Voice Profile</label>
                                    <select class="form-select" id="voiceProfile" required>
                                        <option value="">Select a voice profile...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="promptList" class="form-label">Prompt Lists <span class="badge bg-info">Multiple Selection</span></label>
                                    <select class="form-select" id="promptList" multiple size="3" required>
                                        <option value="">Select prompt lists...</option>
                                    </select>
                                    <small class="form-text text-muted">Hold Ctrl/Cmd for multiple</small>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <label class="form-label">Audio Source</label>
                                    <div class="d-flex gap-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="audioSource" id="audioSourceOriginal" value="original" checked>
                                            <label class="form-check-label" for="audioSourceOriginal">
                                                <strong>Original Recordings</strong>
                                                <span id="originalCount" class="badge bg-secondary ms-1">0 files</span>
                                            </label>
                                            <div class="parameter-help mt-1">
                                                Use the original, unprocessed recordings
                                            </div>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="audioSource" id="audioSourcePreprocessed" value="preprocessed">
                                            <label class="form-check-label" for="audioSourcePreprocessed">
                                                <strong>Preprocessed Recordings</strong>
                                                <span id="preprocessedCount" class="badge bg-secondary ms-1">0 files</span>
                                            </label>
                                            <div class="parameter-help mt-1">
                                                Use processed recordings with normalized volume and trimmed silence
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label for="trainSplit" class="form-label">Training Split</label>
                                    <input type="range" class="form-range" id="trainSplit" min="70" max="95" value="85" step="5">
                                    <div class="d-flex justify-content-between">
                                        <small>70%</small>
                                        <small id="trainSplitValue">85%</small>
                                        <small>95%</small>
                                    </div>
                                    <div class="parameter-help mt-1">
                                        Percentage of data used for training. <span class="recommended-value">Recommended: 85%</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="validationSplit" class="form-label">Validation Split</label>
                                    <input type="range" class="form-range" id="validationSplit" min="5" max="30" value="15" step="5">
                                    <div class="d-flex justify-content-between">
                                        <small>5%</small>
                                        <small id="validationSplitValue">15%</small>
                                        <small>30%</small>
                                    </div>
                                    <div class="parameter-help mt-1">
                                        Percentage of data used for validation. <span class="recommended-value">Recommended: 15%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Model Parameters -->
                    <div class="card parameter-card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-brain me-2"></i>Model Parameters
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="modelSize" class="form-label">Model Size</label>
                                    <select class="form-select" id="modelSize" required>
                                        <option value="small">Small (Fast, Lower Quality)</option>
                                        <option value="medium" selected>Medium (Balanced)</option>
                                        <option value="large">Large (Slow, High Quality)</option>
                                    </select>
                                    <div class="parameter-help mt-1">
                                        Model complexity. <span class="recommended-value">Recommended: Medium</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="learningRate" class="form-label">Learning Rate</label>
                                    <input type="number" class="form-control" id="learningRate" value="0.0001" step="0.0001" min="0.00001" max="0.01">
                                    <div class="parameter-help mt-1">
                                        How fast the model learns. <span class="recommended-value">Recommended: 0.0001</span>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label for="batchSize" class="form-label">Batch Size</label>
                                    <select class="form-select" id="batchSize" required>
                                        <option value="8">8 (Low Memory)</option>
                                        <option value="16" selected>16 (Balanced)</option>
                                        <option value="32">32 (High Memory)</option>
                                        <option value="64">64 (Very High Memory)</option>
                                    </select>
                                    <div class="parameter-help mt-1">
                                        Number of samples processed together. <span class="recommended-value">Recommended: 16</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="epochs" class="form-label">Epochs</label>
                                    <input type="number" class="form-control" id="epochs" value="100" min="10" max="1000">
                                    <div class="parameter-help mt-1">
                                        Number of complete passes through the dataset. <span class="recommended-value">Recommended: 100</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Training Options -->
                    <div class="card parameter-card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-sliders-h me-2"></i>Training Options
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="saveInterval" class="form-label">Save Interval (epochs)</label>
                                    <input type="number" class="form-control" id="saveInterval" value="10" min="1" max="50">
                                    <div class="parameter-help mt-1">
                                        How often to save checkpoints. <span class="recommended-value">Recommended: 10</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="earlyStopping" class="form-label">Early Stopping Patience</label>
                                    <input type="number" class="form-control" id="earlyStopping" value="20" min="5" max="100">
                                    <div class="parameter-help mt-1">
                                        Stop training if no improvement for N epochs. <span class="recommended-value">Recommended: 20</span>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="useGPU" checked>
                                        <label class="form-check-label" for="useGPU">
                                            Use GPU Acceleration
                                        </label>
                                        <div class="parameter-help mt-1">
                                            Significantly faster training if GPU is available
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="mixedPrecision" checked>
                                        <label class="form-check-label" for="mixedPrecision">
                                            Mixed Precision Training
                                        </label>
                                        <div class="parameter-help mt-1">
                                            Faster training with lower memory usage
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="useMFA" checked>
                                        <label class="form-check-label" for="useMFA">
                                            <i class="fas fa-align-center me-1"></i>Use MFA Alignment
                                        </label>
                                        <div class="parameter-help mt-1">
                                            <strong>Best quality!</strong> Uses Montreal Forced Aligner for precise audio-text timing. Fallback to basic if unavailable.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Output Configuration -->
                    <div class="card parameter-card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-folder-open me-2"></i>Output Configuration
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="outputDir" class="form-label">Output Directory</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="outputDir" value="./models" placeholder="./models">
                                        <button class="btn btn-outline-secondary" type="button" onclick="browseOutputDir()">
                                            <i class="fas fa-folder-open"></i> Browse
                                        </button>
                                    </div>
                                    <div class="parameter-help mt-1">
                                        Directory where trained models will be saved
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="modelName" class="form-label">Model Name</label>
                                    <input type="text" class="form-control" id="modelName" placeholder="my_voice_model">
                                    <div class="parameter-help mt-1">
                                        Name for your trained model (auto-generated if empty)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="col-lg-4">
                <!-- Terminal Command -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-terminal me-2"></i>Terminal Command
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <small class="text-muted">Copy this command to run training manually:</small>
                        </div>
                        <div class="bg-dark text-light p-3 rounded" style="font-family: 'Courier New', monospace; font-size: 0.85em;">
                            <code id="terminalCommand">Select parameters to generate command...</code>
                        </div>
                        <button class="btn btn-outline-primary btn-sm mt-2" onclick="copyCommand()">
                            <i class="fas fa-copy me-1"></i> Copy Command
                        </button>
                    </div>
                </div>

                <!-- Training Controls -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-play me-2"></i>Training Controls
                        </h5>
                    </div>
                    <div class="card-body">
                        <button type="button" class="btn btn-success w-100 mb-3" id="startTrainingBtn" onclick="startTraining()">
                            <i class="fas fa-play me-2"></i>Start Training
                        </button>
                        <button type="button" class="btn btn-danger w-100 d-none" id="stopTrainingBtn" onclick="stopTraining()">
                            <i class="fas fa-stop me-2"></i>Stop Training
                        </button>

                        <div class="mt-3">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">Estimated Time:</small>
                                <small id="estimatedTime">-</small>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">GPU Available:</small>
                                <small id="gpuStatus">Checking...</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Training Progress -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>Training Progress
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="progressContainer" class="d-none">
                            <div class="progress mb-3">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span id="progressText">0 / 0 epochs</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">Current Loss:</small>
                                <small id="currentLoss">-</small>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">ETA:</small>
                                <small id="eta">-</small>
                            </div>
                        </div>
                        <div id="noProgress" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>No training in progress
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Training Console -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-terminal me-2"></i>Training Console
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="trainingConsole" class="terminal-output p-3" style="display: none;">
                            <div class="text-center text-muted">
                                <i class="fas fa-info-circle me-2"></i>Training console will appear here when training starts
                            </div>
                        </div>
                        <div id="noConsole" class="text-center text-muted p-3">
                            <i class="fas fa-info-circle me-2"></i>No training in progress
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', path='js/app.js') }}"></script>
    <script>
        let currentTrainingJob = null;
        let progressInterval = null;

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadVoiceProfiles();
            setupEventListeners();
            updateTerminalCommand();
            checkGPUStatus();
            loadAvailableCheckpoints(); // Load available checkpoints
        });

        function setupEventListeners() {
            // Training type change
            document.querySelectorAll('input[name="trainingType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const checkpointSelection = document.getElementById('checkpointSelection');
                    checkpointSelection.style.display = this.value === 'fine_tune' ? 'block' : 'none';
                    updateTerminalCommand();
                });
            });

            // Range sliders
            document.getElementById('trainSplit').addEventListener('input', function() {
                document.getElementById('trainSplitValue').textContent = this.value + '%';
                updateTerminalCommand();
            });

            document.getElementById('validationSplit').addEventListener('input', function() {
                document.getElementById('validationSplitValue').textContent = this.value + '%';
                updateTerminalCommand();
            });

            // Checkpoint management
            document.getElementById('refreshCheckpoints').addEventListener('click', loadAvailableCheckpoints);
            document.getElementById('downloadCheckpoint').addEventListener('click', downloadSelectedCheckpoint);
            document.getElementById('baseVoice').addEventListener('change', function() {
                updateCheckpointButtons();
                updateTerminalCommand();
            });
            document.getElementById('checkpointPath').addEventListener('input', updateTerminalCommand);

            // All other inputs
            ['voiceProfile', 'promptList', 'modelSize', 'learningRate', 'batchSize', 'epochs',
             'saveInterval', 'earlyStopping', 'useGPU', 'mixedPrecision', 'useMFA', 'outputDir', 'modelName'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateTerminalCommand);
                document.getElementById(id).addEventListener('input', updateTerminalCommand);
            });
        }

        function loadVoiceProfiles() {
            fetch('/api/profiles')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('voiceProfile');
                    select.innerHTML = '<option value="">Select a voice profile...</option>';
                    data.forEach(profile => {
                        const option = document.createElement('option');
                        option.value = profile.id;
                        option.textContent = profile.name;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading profiles:', error));
        }

        function loadPromptLists() {
            const profileId = document.getElementById('voiceProfile').value;
            if (!profileId) {
                document.getElementById('promptList').innerHTML = '<option value="">Select a prompt list...</option>';
                updateFileCounts();
                return;
            }

            fetch(`/api/postprocess/datasets/${profileId}`)
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('promptList');
                    select.innerHTML = '<option value="">Select a prompt list...</option>';
                    data.forEach(dataset => {
                        const option = document.createElement('option');
                        option.value = dataset.id;
                        option.textContent = dataset.display_name;
                        select.appendChild(option);
                    });
                    updateFileCounts();
                })
                .catch(error => console.error('Error loading prompt lists:', error));
        }

        async function updateFileCounts() {
            const profileId = document.getElementById('voiceProfile').value;
            const promptListSelect = document.getElementById('promptList');
            const selectedOptions = Array.from(promptListSelect.selectedOptions).map(opt => opt.value).filter(v => v);
            
            if (!profileId || selectedOptions.length === 0) {
                document.getElementById('originalCount').textContent = '0 files';
                document.getElementById('preprocessedCount').textContent = '0 files';
                return;
            }

            try {
                const response = await fetch(`/api/train/file-counts/${profileId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt_list_ids: selectedOptions })
                });
                const data = await response.json();
                
                document.getElementById('originalCount').textContent = `${data.original_count || 0} files`;
                document.getElementById('preprocessedCount').textContent = `${data.preprocessed_count || 0} files`;
                
                // Disable preprocessed option if no preprocessed files exist
                const preprocessedRadio = document.getElementById('audioSourcePreprocessed');
                if (data.preprocessed_count === 0) {
                    preprocessedRadio.disabled = true;
                    document.getElementById('audioSourceOriginal').checked = true;
                } else {
                    preprocessedRadio.disabled = false;
                }
            } catch (error) {
                console.error('Error loading file counts:', error);
            }
        }

        function updateTerminalCommand() {
            const trainingType = document.querySelector('input[name="trainingType"]:checked').value;
            const profileId = document.getElementById('voiceProfile').value;
            const promptListId = document.getElementById('promptList').value;
            const modelSize = document.getElementById('modelSize').value;
            const learningRate = document.getElementById('learningRate').value;
            const batchSize = document.getElementById('batchSize').value;
            const epochs = document.getElementById('epochs').value;
            const trainSplit = document.getElementById('trainSplit').value;
            const validationSplit = document.getElementById('validationSplit').value;
            const saveInterval = document.getElementById('saveInterval').value;
            const earlyStopping = document.getElementById('earlyStopping').value;
            const useGPU = document.getElementById('useGPU').checked;
            const mixedPrecision = document.getElementById('mixedPrecision').checked;
            const useMFA = document.getElementById('useMFA').checked;
            const outputDir = document.getElementById('outputDir').value;
            const modelName = document.getElementById('modelName').value;
            const checkpointPath = document.getElementById('checkpointPath').value;
            const baseVoice = document.getElementById('baseVoice').value;

            if (!profileId || !promptListId) {
                document.getElementById('terminalCommand').textContent = 'Select voice profile and prompt list to generate command...';
                return;
            }

            let command = 'python train_model.py';
            command += ` --profile-id "${profileId}"`;
            command += ` --prompt-list-id "${promptListId}"`;
            command += ` --language-code "${profileId.split('_')[0] || 'en-US'}"`; // Extract language from profile
            command += ` --model-size ${modelSize}`;
            command += ` --learning-rate ${learningRate}`;
            command += ` --batch-size ${batchSize}`;
            command += ` --epochs ${epochs}`;
            command += ` --train-split ${trainSplit / 100}`;
            command += ` --validation-split ${validationSplit / 100}`;
            command += ` --save-interval ${saveInterval}`;
            command += ` --early-stopping ${earlyStopping}`;
            command += ` --output-dir "${outputDir}"`;

            if (modelName) {
                command += ` --model-name "${modelName}"`;
            }

            if (trainingType === 'fine_tune') {
                if (baseVoice) {
                    command += ` --base-voice "${baseVoice}"`;
                } else if (checkpointPath) {
                    command += ` --checkpoint "${checkpointPath}"`;
                }
            }

            if (useGPU) {
                command += ' --use-gpu';
            }

            if (mixedPrecision) {
                command += ' --mixed-precision';
            }

            if (useMFA) {
                command += ' --use-mfa';
            } else {
                command += ' --no-use-mfa';
            }

            document.getElementById('terminalCommand').textContent = command;
            updateEstimatedTime();
        }

        function updateEstimatedTime() {
            const epochs = parseInt(document.getElementById('epochs').value);
            const batchSize = parseInt(document.getElementById('batchSize').value);
            const modelSize = document.getElementById('modelSize').value;
            const useGPU = document.getElementById('useGPU').checked;

            // Rough estimation based on parameters
            let timePerEpoch = 5; // minutes

            if (modelSize === 'small') timePerEpoch *= 0.5;
            else if (modelSize === 'large') timePerEpoch *= 2;

            if (batchSize <= 8) timePerEpoch *= 1.5;
            else if (batchSize >= 32) timePerEpoch *= 0.7;

            if (!useGPU) timePerEpoch *= 3;

            const totalMinutes = epochs * timePerEpoch;
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.round(totalMinutes % 60);

            if (hours > 0) {
                document.getElementById('estimatedTime').textContent = `${hours}h ${minutes}m`;
            } else {
                document.getElementById('estimatedTime').textContent = `${minutes}m`;
            }
        }

        function checkGPUStatus() {
            fetch('/api/train/gpu-status')
                .then(response => response.json())
                .then(data => {
                    const status = data.available ? 'Available' : 'Not Available';
                    const color = data.available ? 'text-success' : 'text-warning';
                    document.getElementById('gpuStatus').innerHTML = `<span class="${color}">${status}</span>`;
                })
                .catch(error => {
                    document.getElementById('gpuStatus').innerHTML = '<span class="text-muted">Unknown</span>';
                });
        }

        function copyCommand() {
            const command = document.getElementById('terminalCommand').textContent;
            navigator.clipboard.writeText(command).then(() => {
                // Show success feedback
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check me-1"></i> Copied!';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-primary');

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-primary');
                }, 2000);
            });
        }

        function handleCheckpointFileSelect(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                // Use the full path if available (security restricted in most browsers)
                // Otherwise use relative path from file name
                const pathInput = document.getElementById('checkpointPath');
                
                // Try to get full path (won't work in most browsers due to security)
                const fullPath = file.path || file.webkitRelativePath || file.name;
                
                // If we got just the filename, suggest the checkpoints directory
                if (fullPath === file.name) {
                    // Guess checkpoint location based on filename
                    if (file.name.includes('sv-') || file.name.includes('swedish')) {
                        pathInput.value = `checkpoints/sv-SE/${file.name}`;
                    } else if (file.name.includes('en-')) {
                        pathInput.value = `checkpoints/en-US/${file.name}`;
                    } else {
                        pathInput.value = `checkpoints/${file.name}`;
                    }
                    
                    // Show info about manual path
                    alert(`Selected: ${file.name}\n\nNote: For security, browsers don't provide the full file path.\n\nPlease verify the path is correct or edit manually:\n${pathInput.value}\n\nOr copy the file to the suggested location.`);
                } else {
                    // We got a full path (Electron, some desktop browsers)
                    pathInput.value = fullPath.replace(/\\/g, '/'); // Convert Windows paths
                }
            }
        }

        function browseOutputDir() {
            // This would open a directory browser in a real implementation
            alert('Directory browser would open here. For now, please enter the path manually.');
        }

        function startTraining() {
            const promptListSelect = document.getElementById('promptList');
            const promptListIds = Array.from(promptListSelect.selectedOptions).map(opt => opt.value).filter(v => v);

            if (promptListIds.length === 0) {
                alert('Please select at least one prompt list.');
                return;
            }

            const formData = new FormData();
            formData.append('training_type', document.querySelector('input[name="trainingType"]:checked').value);
            formData.append('profile_id', document.getElementById('voiceProfile').value);
            formData.append('prompt_list_ids', JSON.stringify(promptListIds));
            formData.append('model_size', document.getElementById('modelSize').value);
            formData.append('learning_rate', document.getElementById('learningRate').value);
            formData.append('batch_size', document.getElementById('batchSize').value);
            formData.append('epochs', document.getElementById('epochs').value);
            formData.append('train_split', document.getElementById('trainSplit').value / 100);
            formData.append('validation_split', document.getElementById('validationSplit').value / 100);
            formData.append('save_interval', document.getElementById('saveInterval').value);
            formData.append('early_stopping', document.getElementById('earlyStopping').value);
            formData.append('use_gpu', document.getElementById('useGPU').checked);
            formData.append('mixed_precision', document.getElementById('mixedPrecision').checked);
            formData.append('use_mfa', document.getElementById('useMFA').checked);
            formData.append('output_dir', document.getElementById('outputDir').value);
            formData.append('model_name', document.getElementById('modelName').value);
            formData.append('checkpoint_path', document.getElementById('checkpointPath').value);

            const startBtn = document.getElementById('startTrainingBtn');
            const stopBtn = document.getElementById('stopTrainingBtn');

            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting...';

            // Show progress and console
            document.getElementById('progressContainer').classList.remove('d-none');
            document.getElementById('noProgress').classList.add('d-none');
            document.getElementById('trainingConsole').style.display = 'block';
            document.getElementById('noConsole').style.display = 'none';

            fetch('/api/train/start', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentTrainingJob = data.job_id;
                    startProgressTracking();
                    startBtn.style.display = 'none';
                    stopBtn.classList.remove('d-none');
                } else {
                    throw new Error(data.error || 'Failed to start training');
                }
            })
            .catch(error => {
                console.error('Error starting training:', error);
                alert('Error starting training: ' + error.message);
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-play me-2"></i>Start Training';
            });
        }

        function stopTraining() {
            if (!currentTrainingJob) return;

            fetch(`/api/train/stop/${currentTrainingJob}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Training stopped successfully');
                    resetTrainingUI();
                } else {
                    alert('Error stopping training: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error stopping training:', error);
                alert('Error stopping training: ' + error.message);
            });
        }

        function startProgressTracking() {
            progressInterval = setInterval(() => {
                fetch(`/api/train/status/${currentTrainingJob}`)
                    .then(response => response.json())
                    .then(data => {
                        updateProgress(data);
                        updateConsole(data.console_output);

                        if (data.status === 'completed' || data.status === 'failed' || data.status === 'stopped') {
                            clearInterval(progressInterval);
                            resetTrainingUI();

                            if (data.status === 'completed') {
                                alert('Training completed successfully!');
                            } else if (data.status === 'failed') {
                                alert('Training failed: ' + (data.error || 'Unknown error'));
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error checking progress:', error);
                    });
            }, 2000);
        }

        function updateProgress(data) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressPercent = document.getElementById('progressPercent');
            const currentLoss = document.getElementById('currentLoss');
            const eta = document.getElementById('eta');

            const percentage = Math.round((data.current_epoch / data.total_epochs) * 100);

            progressBar.style.width = percentage + '%';
            progressText.textContent = `${data.current_epoch} / ${data.total_epochs} epochs`;
            progressPercent.textContent = percentage + '%';
            currentLoss.textContent = data.current_loss ? data.current_loss.toFixed(4) : '-';
            eta.textContent = data.eta || '-';
        }

        function updateConsole(output) {
            const console = document.getElementById('trainingConsole');
            if (output && output.length > 0) {
                console.innerHTML = output.map(line => `<div>${line}</div>`).join('');
                console.scrollTop = console.scrollHeight;
            }
        }

        // Checkpoint Management Functions
        function loadAvailableCheckpoints() {
            const statusSpan = document.getElementById('checkpointStatus');
            statusSpan.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';

            fetch('/api/checkpoints')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        populateCheckpointSelect(data.checkpoints);
                        statusSpan.innerHTML = '<span class="text-success"><i class="fas fa-check me-1"></i>Loaded</span>';
                    } else {
                        statusSpan.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Error</span>';
                        console.error('Error loading checkpoints:', data.error);
                    }
                })
                .catch(error => {
                    statusSpan.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Error</span>';
                    console.error('Error loading checkpoints:', error);
                });
        }

        function populateCheckpointSelect(checkpoints) {
            const select = document.getElementById('baseVoice');
            select.innerHTML = '<option value="">Select a base voice...</option>';

            Object.keys(checkpoints).forEach(language => {
                const languageCheckpoints = checkpoints[language];
                if (languageCheckpoints.length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = language;

                    languageCheckpoints.forEach(checkpoint => {
                        const option = document.createElement('option');
                        option.value = `${language}.${checkpoint.voice_id}`;
                        option.textContent = `${checkpoint.name} (${checkpoint.gender}, ${checkpoint.quality})`;
                        if (checkpoint.downloaded) {
                            option.textContent += ' ';
                        }
                        optgroup.appendChild(option);
                    });

                    select.appendChild(optgroup);
                }
            });
        }

        function updateCheckpointButtons() {
            const baseVoice = document.getElementById('baseVoice').value;
            const downloadBtn = document.getElementById('downloadCheckpoint');

            if (baseVoice) {
                const [language, voiceId] = baseVoice.split('.');
                // Check if checkpoint is downloaded
                fetch(`/api/checkpoints/${language}/${voiceId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if (data.downloaded) {
                                downloadBtn.style.display = 'none';
                            } else {
                                downloadBtn.style.display = 'inline-block';
                            }
                        }
                    })
                    .catch(error => console.error('Error checking checkpoint status:', error));
            } else {
                downloadBtn.style.display = 'none';
            }
        }

        function downloadSelectedCheckpoint() {
            const baseVoice = document.getElementById('baseVoice').value;
            if (!baseVoice) return;

            const [language, voiceId] = baseVoice.split('.');
            const downloadBtn = document.getElementById('downloadCheckpoint');
            const statusSpan = document.getElementById('checkpointStatus');

            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Downloading...';
            statusSpan.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Downloading...';

            fetch(`/api/checkpoints/${language}/${voiceId}/download`, {
                method: 'POST'
            })
            .then(async response => {
                if (!response.ok) {
                    // Handle HTTP errors
                    const errorData = await response.json().catch(() => ({ detail: response.statusText }));
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    statusSpan.innerHTML = '<span class="text-success"><i class="fas fa-check me-1"></i>Downloaded</span>';
                    downloadBtn.style.display = 'none';
                    alert(`Checkpoint downloaded successfully!\n\nLocation: ${data.checkpoint_path || 'checkpoints/' + language + '/' + voiceId}`);
                    // Refresh the select to show downloaded status
                    loadAvailableCheckpoints();
                } else {
                    const errorMsg = data.error || data.message || 'Unknown error';
                    statusSpan.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Failed</span>';
                    alert('Download failed: ' + errorMsg);
                    console.error('Download failed:', errorMsg);
                }
            })
            .catch(error => {
                statusSpan.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Error</span>';
                alert('Download error: ' + error.message);
                console.error('Download error:', error);
            })
            .finally(() => {
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = '<i class="fas fa-download me-1"></i>Download Selected Model';
            });
        }

        function resetTrainingUI() {
            const startBtn = document.getElementById('startTrainingBtn');
            const stopBtn = document.getElementById('stopTrainingBtn');

            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fas fa-play me-2"></i>Start Training';
            startBtn.style.display = 'block';
            stopBtn.classList.add('d-none');

            document.getElementById('progressContainer').classList.add('d-none');
            document.getElementById('noProgress').classList.remove('d-none');
            document.getElementById('trainingConsole').style.display = 'none';
            document.getElementById('noConsole').style.display = 'block';

            currentTrainingJob = null;
        }

        // Add event listener for voice profile change
        document.getElementById('voiceProfile').addEventListener('change', function() {
            loadPromptLists();
            updateTerminalCommand();
        });

        // Add event listener for prompt list change
        document.getElementById('promptList').addEventListener('change', function() {
            updateFileCounts();
            updateTerminalCommand();
        });

        // Add event listener for audio source change
        document.querySelectorAll('input[name="audioSource"]').forEach(radio => {
            radio.addEventListener('change', updateTerminalCommand);
        });
    </script>
</body>
</html>
